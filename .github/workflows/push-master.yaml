---
name: Build
on:
  push:
    branches:
      - master
jobs:
  release-docker-build:
    name: Release Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        id: checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: '0'
      - name: Build PNGs
        id: png
        run: |
          echo ${PWD}/svg/
          find ${PWD}/svg/ -type f -name \*.svg | while read LINE
          do
            INPUTDIR=$( dirname ${LINE})
            OUTPUTDIR=${INPUTDIR/#${PWD}\/svg/${PWD}\/png}
            INPUT=$( basename ${LINE})
            OUTPUT=${INPUT/.svg/.png}
            echo docker run --rm -v ${INPUTDIR}:/input -v ${OUTPUTDIR}:/output docker.io/illallangi/toolbx:v0.6.0 rsvg-convert /input/${INPUT} -o /output/${OUTPUT} -d 600 -p 600
            docker run --rm -v ${INPUTDIR}:/input -v ${OUTPUTDIR}:/output docker.io/illallangi/toolbx:v0.6.0 rsvg-convert /input/${INPUT} -o /output/${OUTPUT} -d 600 -p 600
            echo
          done
      - name: Archive PNG files for Release
        uses: thedoctor0/zip-release@master
        with:
          filename: png.zip
          directory: png
      - name: Archive SVG files for Release
        uses: thedoctor0/zip-release@master
        with:
          filename: svg.zip
          directory: svg
      - name: Bump Version
        if: success()
        id: github-tag
        uses: anothrNick/github-tag-action@1.17.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WITH_V: true
      - name: Create Release
        if: success()
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.github-tag.outputs.tag }}
          release_name: ${{ steps.github-tag.outputs.tag }}
          draft: false
          prerelease: false
      - name: Upload SVG Release Asset
        id: upload-release-asset-svg
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./svg/svg.zip
          asset_name: Illallangi-VisioStencils-SVG-${{ steps.github-tag.outputs.tag }}.zip
          asset_content_type: application/zip
      - name: Upload PNG Release Asset
        id: upload-release-asset-png
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./png/png.zip
          asset_name: Illallangi-VisioStencils-PNG-${{ steps.github-tag.outputs.tag }}.zip
          asset_content_type: application/zip
